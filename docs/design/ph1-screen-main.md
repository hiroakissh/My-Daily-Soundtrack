# 画面仕様: サウンドスケープ・メイン（PH1）

## メタ情報
- 画面名: サウンドスケープ・メイン
- バージョン/更新日: 1.0 / 2024-XX-XX
- 作成者/レビュー担当: 
- 対応フェーズ: PH1

## 目的と役割
- 現在地に応じたサウンドスケープを再生し、ユーザーに「いまの場所」の音体験を提供する。
- 再生/停止のシンプル操作と現在の GeoTag を示す。

## ユーザーフロー
- 主なシナリオ: アプリ起動 → 背景オーディオ開始 → GeoTag 表示と再生インジケータ → 再生/停止操作。
- 前提状態: 位置情報許可済み、バックグラウンドオーディオ有効、初回はオーディオエンジンの初期化。
- 終了条件/戻り動線: ホームに戻る、バックグラウンドで継続再生、停止ボタンでサウンド停止。

## レイアウト概要
- ビューポート: iPhone 15 Pro 390x844pt（他デバイスは AutoLayout/SwiftUI レイアウトで可変）。
- セクション/コンポーネント:
  - ヘッダー: なし（フルスクリーン体験）。
  - メイン: シーン/タグラベル、再生インジケータ。
  - フッター: 再生/停止ボタン（中央寄せ）。
- レイアウト図/リンク: 未定。
- 主要要素の寸法表（目安）:

| 要素 | サイズ(pt) | 余白(pt) | 備考 |
| ---- | ----------- | -------- | ---- |
| GeoTag ラベル | 14 / Semibold | 上 32 | 右上寄せも可 |
| 再生インジケータ | 12〜16 | ラベル近接 | 脈動アニメ |
| Play/Stop ボタン | 64〜72 / 円 | 下 48 | アイコン 24 |

## コンポーネント詳細
- GeoTagラベル
  - 内容/役割: 現在の GeoTag を表示（例: “urban”, “park”）。
  - ステート: normal / hidden（データ欠損）。
  - 相互作用: なし。
  - バインド: `GeoTagStore.tag`。
  - アクセシビリティ: ラベル読み上げ。
- 再生インジケータ
  - 役割: 再生中を示すパルス。
  - ステート: playing（パルス）、paused（停止）、loading（スピナー）。
  - バインド: `PlaybackStore.state`。
  - AX: 「再生中」「一時停止中」。
- 再生/停止ボタン
  - 役割: AudioRenderer を start/stop。
  - ステート: enabled / disabled（初期化中）。
  - 相互作用: タップ。
  - バインド: `PlaybackStore.state`。
  - AX: 「再生」「停止」。
- （開発用）デバッグオーバーレイ
  - 役割: 現在位置座標、タグ、オーディオプリセット名を表示。
  - ステート: dev build のみ表示。

## データ・状態（StateObservationKit / ステートマシン）
- ステートマシン: `PlaybackStore.state`
  - 状態: idle → loading → playing ↔ paused → error
  - 遷移トリガー: 再生タップ、AudioRenderer 初期化完了、位置欠損、エラー復帰。
  - ガード/副作用: AudioEngine start/stop、GeoTag 変更時のクロスフェード。
- 購読ストア: `GeoTagStore.tag`, `PlaybackStore.state`.
- ローカル状態: ボタンのタップ抑制（連打ガード）、パルスアニメのフラグ。
- エラー/ローディング表示: `loading` でスピナー、`error` でトーストとリトライ案内。
- 状態遷移表（例）:

| 現在 | イベント/条件 | 遷移先 | 副作用 |
| ---- | ------------- | ------ | ------ |
| idle | ユーザーが再生タップ | loading | AudioEngine 初期化開始 |
| loading | AudioEngine 準備完了 | playing | GeoTag プリセット適用・フェードイン |
| playing | ボタンタップ | paused | フェードアウト |
| playing | 位置データ欠損 > N 秒 | error | 再生停止、トースト表示 |
| paused | 再生タップ | playing | フェードイン |
| error | リトライタップ | loading | 再初期化 |

## アニメーション・モーション
- 再生インジケータ: 1s のパルス（ease in-out）。
- ボタン: タップ時に 0.95 スケール → 復帰。
- 画面遷移はなし（単一画面）。

## サウンド挙動
- トリガー: `playing` への遷移で再生、`paused/error` でフェードアウト停止。
- GeoTag 変更時: 1–2 秒クロスフェード。
- フィードバック音: なし。

## 空状態・エラー状態
- 位置権限なし: 権限ガイドへ遷移またはモーダル表示。
- 位置取得不可: 「現在地を取得できません」とトースト。前回のサウンドをフェードアウト。

## 権限・デバイス前提
- 必要: 位置情報（When In Use + 背景）、バックグラウンドオーディオ。
- 未許可時: 権限ガイドを表示。

## 計測・ログ（任意）
- イベント: 再生開始/停止、タグ変更、エラー発生。
- メトリクス: 再生継続時間、タグ別滞在時間。

## 未決事項・メモ
- ボタンアイコンのスタイル（シェイプ/グラデーション）。
- デバッグオーバーレイの表示条件とトグル操作。
