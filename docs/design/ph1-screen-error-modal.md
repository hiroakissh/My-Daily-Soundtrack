# 画面仕様: エラー／リトライモーダル（PH1）

## メタ情報
- 画面名: エラー／リトライモーダル
- バージョン/更新日: 1.0 / 2024-XX-XX
- 作成者/レビュー担当:
- 対応フェーズ: PH1

## 目的と役割
- 位置取得不可やオーディオ初期化失敗など、致命的でないエラーをユーザーに伝え、リトライまたは設定誘導の動線を提供する。

## ユーザーフロー
- シナリオ: メイン画面中にエラー発生 → モーダル表示 → リトライ or 設定アプリ遷移 → 成功でメインに復帰。
- 前提: PlaybackStore.state == error または PermissionStore.state == denied。
- 終了条件: リトライ成功またはキャンセルでモーダル閉じ。

## レイアウト概要
- ビューポート: メイン画面上にセンター表示（高さ 320–360pt 程度）。
- セクション/コンポーネント:
  - アイコン: エラー種別に応じて（位置: ロケーションピン、オーディオ: 波形）。
  - タイトル: 短い見出し。
  - メッセージ: 1–2 行。
  - プライマリ CTA: 「再試行」または「権限を許可」。
  - セカンダリ CTA: 「あとで」「設定を開く」など。
- 寸法表（目安）:

| 要素 | サイズ(pt) | 余白(pt) | 備考 |
| ---- | ----------- | -------- | ---- |
| アイコン | 48 | 上 24 | 円形背景 |
| タイトル | 20 / Semibold | 上 16 | 中央揃え |
| メッセージ | 16 / Regular | 上 8 | 2 行まで |
| CTA | 高さ 48 | 上 24 | 角丸 12 |

## コンポーネント詳細
- アイコン
  - 役割: エラー種別の識別。
  - ステート: location_error / audio_error。
  - バインド: エラーコードから選択。
- タイトル/メッセージ
  - 役割: 簡潔な原因と対処を提示。
  - ステート: 文言切替（位置・オーディオ）。
- CTA（プライマリ）
  - 役割: リトライまたは権限ダイアログ誘導。
  - ステート: enabled / loading。
  - バインド: エラーストアの再試行アクション。
- CTA（セカンダリ）
  - 役割: 設定を開く、あとで閉じる。

## データ・状態（StateObservationKit / ステートマシン）
- ステートマシン: `ErrorStore.state`
  - 状態: hidden → showing(error: ErrorType) → retrying → resolved
  - トリガー: PlaybackStore/PermissionStore の error 発火、リトライ成功/失敗。
  - 副作用: GeoTagProvider 再初期化、AudioEngine 再起動、設定アプリディープリンク。
- 購読ストア: `ErrorStore.state`.
- ローカル状態: CTA 連打防止フラグ。
- エラー/ローディング表示: retrying でインジケータ。
- 状態遷移表（例）:

| 現在 | イベント/条件 | 遷移先 | 副作用 |
| ---- | ------------- | ------ | ------ |
| hidden | PlaybackStore.error | showing(audio_error) | モーダル表示 |
| hidden | PermissionStore.denied | showing(location_error) | モーダル表示 |
| showing | プライマリ CTA | retrying | 再初期化開始 |
| retrying | 成功 | resolved | モーダル閉じ、Playback 再開 |
| retrying | 失敗 | showing | エラー文言更新 |
| showing | 設定を開く | showing | 設定アプリ起動 |
| showing | 閉じる | hidden | モーダル閉じ |

## アニメーション・モーション
- モーダル表示/非表示: フェード + 上下 12pt スライド (200–250ms)。
- CTA タップ: 0.95 スケール。

## サウンド挙動
- エラー中は再生停止。復帰時はフェードイン。

## 空状態・エラー状態
- モーダル自体がエラー表示。追加は不要。

## 権限・デバイス前提
- 位置/背景オーディオが未許可の場合の文言を用意。

## 計測・ログ（任意）
- イベント: エラー発生種別、リトライ成功率、設定遷移率。

## 未決事項・メモ
- 文言最終決定（カジュアル/フォーマル）。
- モーダルのトーン: ダーク基調でパレット #3098F2〜#49C2F2 をアクセント、警告時に #ABD948 を少量。
